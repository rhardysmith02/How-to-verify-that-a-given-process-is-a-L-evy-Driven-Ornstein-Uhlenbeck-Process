---
title: "Dm-Yen/USD"
output: html_document
date: "2024-10-19"
---

Load Packages

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include=FALSE}
# Dependence modelling 
library(fBasics) 
library(lmtest) 
library(MASSExtra)
library(rootSolve)
library(dplyr) 
library(readr) 
library(readxl) 
# Data handling 
library(tidyverse)
library(texreg)
library(lubridate)
#library(xlsx) 
library(xts) 
library(zoo) 
library(PerformanceAnalytics) 
library(QRM) 
library(quantmod)
# Financial modelling 
library(ggplot2)
library(sandwich) 
library(timeSeries) 
#library(tseries) 
library(TTR)
```

## Import data

The DM/USD and Yen/USD data are structure the same. They are given as: Year, Month, Day, an unnecessary column that is structured as a counter of some sort (we OMIT), a counter from 1-288 for each day (we OMIT), and then DM/USD returns and Yen/USD returns respectively. The returns are given to us, so we require no calculation.

The data sets are cleaned and dealt with the same, so they are interchangeable within this document. We observe very similar results between the two.

DM/USD data

```{r}
exchange <- read.table("dm_all_raw.txt")
exchange <- as.data.frame(exchange)
```

Yen/USD data

```{r}
exchange <- read.table("yen_all_raw.txt")
exchange <- as.data.frame(exchange)
```

Creating vectors for each row in the data frame

```{r}
v1_updated=c(exchange[[1]])
v2_updated=c(exchange[[2]])
v3_updated=c(exchange[[3]])
v4_updated=c(exchange[[4]])
v5_updated=c(exchange[[5]])
v6_updated=c(exchange[[6]]) 
```

Creating data frame with necessary vectores

```{r}
exchange_updated = data.frame(v1_updated,v2_updated,v3_updated,v6_updated)
```

Creating proper columns for date (year, month, day) and time (5 min intervals)

```{r}
exchange_updated$Date <- as.Date(with(exchange_updated, paste(v1_updated, v2_updated, v3_updated, sep = "-")), format = "%y-%m-%d")

time_intervals <- format(seq(from = as.POSIXct("00:05:00", format = "%H:%M:%S"), 
                             by = "5 mins", length.out = 288), "%H:%M:%S")

exchange_updated$Time <- rep(time_intervals, length.out = nrow(exchange_updated))

exchange_updated <- exchange_updated[, c("Date", "Time", "v6_updated")]
names(exchange_updated)[3] <- "Returns"
```

Cleaning out weekends

```{r}
exchange_updated$DayOfWeek <- weekdays(exchange_updated$Date)

exchange_updated <- exchange_updated[!(exchange_updated$DayOfWeek == "Saturday" | exchange_updated$DayOfWeek == "Sunday"), ]
```

Cleaning Christmas

```{r}
exchange_updated <- exchange_updated[!(format(exchange_updated$Date, "%m") == "12" & format(exchange_updated$Date, "%d") %in% c("24", "25", "26")), ]
```

Cleaning New Years

```{r}
exchange_updated <- exchange_updated[!(format(exchange_updated$Date, "%m") == "12" & format(exchange_updated$Date, "%d") == "31"), ]
exchange_updated <- exchange_updated[!(format(exchange_updated$Date, "%m") == "01" & format(exchange_updated$Date, "%d") %in% c("01", "02")), ]
```

Cleaning July 4th

```{r}
exchange_updated <- exchange_updated[!(format(exchange_updated$Date, "%m") == "07" & format(exchange_updated$Date, "%d") == "04"), ]
```

Cleaning Labor Day

```{r}
labor_day_dates <- as.Date(c(
  "1986-09-01", "1987-09-07", "1988-09-05", "1989-09-04", "1990-09-03", 
  "1991-09-02", "1992-09-07", "1993-09-06", "1994-09-05", "1995-09-04", "1996-09-02"))

exchange_updated <- exchange_updated[!(exchange_updated$Date %in% labor_day_dates), ]
```

Cleaning Thanksgiving

```{r}
thanksgiving_day_dates <- as.Date(c("1986-11-27",
  "1987-11-26", "1988-11-24", "1989-11-23", "1990-11-22", "1991-11-28", 
  "1992-11-26", "1993-11-25", "1994-11-24", "1995-11-23", "1996-11-28"))

exchange_updated <- exchange_updated[!(exchange_updated$Date %in% thanksgiving_day_dates), ]
```

Cleaning day after Thanksgiving 

```{r}
thanksgiving_day_dates_2 <- as.Date(c("1986-11-28",
  "1987-11-27", "1988-11-25", "1989-11-24", "1990-11-23", "1991-11-29", 
  "1992-11-27", "1993-11-26", "1994-11-25", "1995-11-24", "1996-11-29"))

exchange_updated <- exchange_updated[!(exchange_updated$Date %in% thanksgiving_day_dates_2), ]
```

Cleaning Memorial Day

```{r}
memorial_day_dates <- as.Date(c("1986-05-26", "1987-05-25", "1988-05-30", "1989-05-29", "1990-05-28", "1991-05-27", 
  "1992-05-25", "1993-05-31", "1994-05-30", "1995-05-29", "1996-05-27"))

exchange_updated <- exchange_updated[!(exchange_updated$Date %in% memorial_day_dates), ]
```

Cleaning Good Friday

```{r}
good_friday_dates <- as.Date(c("1986-03-28", "1987-04-17", "1988-04-01", "1989-03-24", "1990-04-13", "1991-03-29", "1992-04-17", "1993-04-09", "1994-04-01", "1995-04-14", "1996-04-05"))

exchange_updated <- exchange_updated[!(exchange_updated$Date %in% good_friday_dates), ]
```

Cleaning Easter Monday

```{r}
easter_sunday_dates <- as.Date(c("1986-03-30", "1987-04-19", "1988-04-03", "1989-03-26", "1990-04-15", "1991-03-31", "1992-04-19", "1993-04-11", "1994-04-03", "1995-04-16", "1996-04-07"))

easter_monday_dates <- easter_sunday_dates + 1

exchange_updated <- exchange_updated[!(exchange_updated$Date %in% easter_monday_dates), ]
```

Cleaning random July 4ths

```{r}
exchange_updated <- exchange_updated[!(exchange_updated$Date == as.Date("1987-07-03") | exchange_updated$Date == as.Date("1992-07-03")), ]

exchange_updated <- exchange_updated[, !names(exchange_updated) %in% "weekday"]
```

Cleaning 15 longest 0 runs out

```{r}
zero_runs <- rle(exchange_updated$Returns == 0)

zero_runs_df <- data.frame(
  lengths = zero_runs$lengths,
  values = zero_runs$values,
  start_positions = cumsum(c(1, head(zero_runs$lengths, -1)))
)

longest_zero_runs <- zero_runs_df[zero_runs_df$values == TRUE, ]
longest_zero_runs <- longest_zero_runs[order(-longest_zero_runs$lengths), ]

longest_zero_runs <- head(longest_zero_runs, 15)

for (i in 1:nrow(longest_zero_runs)) {
  start <- longest_zero_runs$start_positions[i]
  end <- start + longest_zero_runs$lengths[i] - 1
  exchange_updated <- exchange_updated[-(start:end), ]
}

exchange_updated <- exchange_updated
```

Plot returns

```{r}
plot.ts(exchange_updated$Returns*100)
```


Calculating returns squared and realized variance

```{r}
return_sq=(exchange_updated$Returns*100)^2

vard=0;
vard[1]=sum(return_sq[1:288])
for(i in 2:2496) {
  n=(i-1)*288; m=i*288
vard[i]=sum(return_sq[n:m])
}
```

Calculating realized volatility 

```{r}
vard=vard[1:2496];

rvard=sqrt(vard)
```

Plotting variance

```{r}
plot.ts(vard)
```

Plotting realized volatility

```{r}
plot.ts(rvard)
```

Estimating $a$ and recovering increments functions

```{r}
Estimated_MLE<-function(data,N,M, sigma)
{
  Delta_1L<- numeric(N);
  S_nM<- numeric(N);
  S_nMean<- numeric(N)
  S_nM[1]=sum(data[1:M]);
  for(n in 2:N) {
    i=(n-1)*M+1; up=n*M;
    S_nM[n] <- sum(data[floor(i):floor(up)])
  }
  S_nMean<- S_nM-mean(S_nM);
  phi_1<- (sum(S_nMean[1:N-1]*S_nMean[2:N]))/(sum(S_nMean^2));
  data=data-mean(data)
  R=length(data)
  phi_Y= (sum(data[1:R-1]*data[2:R]))/(sum(data^2))
  a_hat=-M*phi_Y+M;
  out<- a_hat;
}
```

```{r}
Estimated_Log<-function(data, N, M){
  R = length(data);
  diff=log(data[1:R-1])-log(data[2:R]);
  a_hat=M*(max(diff));
  out<- a_hat;
}
```

```{r}
Recovered_Increments<-function(data,N,a,M,sigma)
{
  Delta_1L<- numeric(N);
  Delta_1L[1]<-(a/(M*sigma))*sum(data[1:M])+(1/sigma-a/(2*M*sigma))*(data[M]-data[1]);
  for(n in 2:N) {
    i=(n-1)*M+1; up=n*M;
    Delta_1L[n] <-
      (a/(M*sigma))*sum(data[floor(i):floor(up)])+(1/sigma-a/(2*M*sigma))*(data[up]-data[i-1])
  }
  out<-Delta_1L;
}
```

Estimating a and recovering increments

```{r}
N <- 2496
M <- 49
sigma <- 1
L <- rvard
#a_h <- Estimated_MLE(L, N, M, sigma)
a_h <- Estimated_Log(L, N, M)
recovered_increments <- Recovered_Increments(L, N, a=a_h, M, sigma)
recovered_increments <- na.omit(recovered_increments)
```

Plotting recovered increments

```{r}
Delta_1L <- recovered_increments

plot(Delta_1L,main="Recovered Increments")
plot.ts(Delta_1L,main="Recovered Increments")
```

```{r}
CARMA_MC<-function(R,N,alpha)
{
  quantile=qnorm(1-alpha/2);
  counter_1=0;
  a_hatMLE=c();
  for(i in 1:R)
  {
    a_1L=acf(Delta_1L, plot = FALSE);
    if(abs(sqrt(N)*a_1L$acf[2])>quantile){counter_1=counter_1+1};
    a_hatMLE[i]=a_h;
  }
  freq_1=counter_1/R;
  print(c(freq_1));
  #print(a_hatMLE)
  #print(a_1L)
}
```

Testing

```{r}
N <- 50
alpha <- 0.05
CARMA_MC(R=1,N,alpha )
```

ACF plot

```{r}
acf(Delta_1L,main="Recovered")
```

Calculating test statistic

```{r}
calculate_test_statistic <- function(Delta_1L, N) {
  a_1L <- acf(Delta_1L, plot = FALSE) 
  test_stat <- sqrt(N) * a_1L$acf[2]
  return(test_stat)
}
calculate_test_statistic(Delta_1L, N)
```

KS Test

```{r}
KS_test<-function(R=10,N=100,K=5000,M=100,mu=0,a=0.9,eta=1,sigma=1,alpha=0.05)
        {
        counter_2=0;
        for(i in 1:R)
                {
                Delta_1L_sample<- sample(Delta_1L, replace=T);
                mu_hat=mean(Delta_1L);
                eta_hat_sqrt=mean((Delta_1L-mu_hat)^2);
                a_1L=ks.test(Delta_1L,"pnorm", mu_hat, sqrt(eta_hat_sqrt));
                a_1L=a_1L$p.value;
                if(a_1L<0.05){counter_2=counter_2+1};
                }
        freq_2=counter_2/R;
        print(freq_2);
        print(a_1L)
}
```

```{r}
KS_test(R=1)
```







